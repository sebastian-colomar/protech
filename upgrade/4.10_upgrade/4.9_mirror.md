# DISCLAIMER
The following material is reproduced from the referenced guides and is provided exclusively for educational and training purposes.
It is provided on an "as-is" basis, without any express or implied warranties, and no responsibility is assumed for its accuracy, completeness, or applicability to any particular use.

---


# 3. Mirror registry for Red Hat OpenShift

NOTE:
> Execute this procedure on a Linux machine reachable by the OpenShift cluster and equipped with at least 1 TB of mounted storage.

#### Procedure
3.1. Set the required environment variables:
   
   ```
   export ARCH_RELEASE=x86_64
   export BINARIES="oc"
   export BINARY_PATH=${HOME}/bin
   export CONTAINER_IMAGE=docker.io/library/registry
   export CONTAINER_IMAGE_TAG=2.7
   export CONTAINER_NAME=registry
   export CONTAINER_PORT=5000
   export CONTAINER_VOLUME=/var/lib/registry
   export MIRROR_HOST=mirror.hub.sebastian-colomar.com
   export MIRROR_PORT=5000
   export MIRROR_PROTOCOL=http
   export OCP_RELEASE_NEW=4.9.59
   export OCP_RELEASE_OLD=4.8.37
   export OCP_REPOSITORY=ocp
   export PACKAGES="openshift-client"
   export PRODUCT_REPO=openshift-release-dev
   export RELEASE_NAME=ocp-release
   export REMOVABLE_MEDIA_PATH=/mnt/mirror
   export RH_INDEX=redhat-operator-index
   export RH_INDEX_VERSION_NEW=v4.9
   export RH_INDEX_VERSION_OLD=v4.8
   export RH_REGISTRY=registry.redhat.io
   export RH_REPOSITORY=redhat

   export CONTAINERS_STORAGE_CONF=${REMOVABLE_MEDIA_PATH}/containers/storage.conf
   export LOCAL_REGISTRY=${MIRROR_HOST}:${MIRROR_PORT}
   export MIRROR_OCP_REPOSITORY=mirror-${OCP_REPOSITORY}
   export MIRROR_OLM_REPOSITORY=mirror-${RH_INDEX}
   export TMPDIR=${REMOVABLE_MEDIA_PATH}/containers/cache

   ```

3.2. Deploy the local container registry using the Distribution container image with the HTTP protocol:
   ```
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/cache
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/containers
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/containers-run

   tee ${REMOVABLE_MEDIA_PATH}/containers/storage.conf 0<<EOF
   [storage]
   driver = "overlay"
   graphroot = "${REMOVABLE_MEDIA_PATH}/containers/containers"
   runroot = "${REMOVABLE_MEDIA_PATH}/containers/containers-run"
   EOF

   podman info | egrep 'graphRoot:|runRoot:|imageCopyTmpDir:'

   semanage fcontext -a -t container_file_t "${REMOVABLE_MEDIA_PATH}/containers/containers(/.*)?"
   semanage fcontext -a -t container_var_run_t "${REMOVABLE_MEDIA_PATH}/containers/containers-run(/.*)?"
   restorecon -Rv ${REMOVABLE_MEDIA_PATH}/containers/containers ${REMOVABLE_MEDIA_PATH}/containers/containers-run

   mkdir -p ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}

   podman load -i ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}.tar

   podman run -d --name ${CONTAINER_NAME} --restart=always -p ${MIRROR_PORT}:${CONTAINER_PORT} -v ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}:${CONTAINER_VOLUME}:Z ${CONTAINER_IMAGE}:${CONTAINER_IMAGE_TAG}

   ```

3.3. Install the OpenShift CLI:
   
   IMPORTANT:
   > If you are upgrading a cluster in a disconnected environment, install the oc version that you plan to upgrade to.

   ```
   cd ${HOME}
   mkdir -p ${BINARY_PATH}
   grep -q ":${BINARY_PATH}:" ~/.bashrc || echo "export PATH=\"${BINARY_PATH}:\${PATH}\"" | tee -a ~/.bashrc
   source ~/.bashrc

   unalias cp mv rm

   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
     for package in ${PACKAGES}; do
       mv ${REMOVABLE_MEDIA_PATH}/${package}-linux-${release}.tar.gz ${HOME}
       tar fvxz ${package}-linux-${release}.tar.gz
     done
     for binary in ${BINARIES}; do
       mv ${binary} ${BINARY_PATH}/${binary}-${release}
     done
   done

   rm ${BINARY_PATH}/oc
   rm kubectl
   rm README.md

   ```   

3.4. Extract the tar archives containing the directory of the mirrored images and catalogs and its contents:

   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      cd ${REMOVABLE_MEDIA_PATH}
      tar fvx ${MIRROR_OCP_REPOSITORY}-${release}.tar
   done

   for release in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
      cd ${REMOVABLE_MEDIA_PATH}
      tar fvx ${MIRROR_OLM_REPOSITORY}-${release}.tar
   done

   ```

3.6. Login to the OpenShift cluster:

   ```
   oc login

   ```

3.6. Upload the release images to the local container registry:

   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      sudo mkdir -p ${REMOVABLE_MEDIA_PATH}/${MIRROR_OCP_REPOSITORY}-${release}
   done

   sudo chown -R ${USER}. ${REMOVABLE_MEDIA_PATH}

   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      alias oc=oc-${release}
      oc image mirror "file://openshift/release:${release}-${ARCH_RELEASE}*" ${LOCAL_REGISTRY}/${MIRROR_OCP_REPOSITORY}-${release} --from-dir=${REMOVABLE_MEDIA_PATH}/${MIRROR_OCP_REPOSITORY}-${release} --insecure
   done

   ```

3.7. Create the mirrored release image signature ConfigMap manifest:

   ```
   alias oc=oc-${OCP_RELEASE_OLD}
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      oc apply -f ${REMOVABLE_MEDIA_PATH}/${MIRROR_OCP_REPOSITORY}-${release}/config/signature-sha256-*.yaml
   done

   ```

3.8. Allow HTTP connections to the mirror registry:

   ```
   alias oc=oc-${OCP_RELEASE_OLD}
   oc patch image.config.openshift.io/cluster --type=merge -p '{"spec":{"registrySources":{"insecureRegistries":["'${LOCAL_REGISTRY}'"]}}}'

   ```

3.9. Create the ImageContentSourcePolicy manifest:

   ```
   alias oc=oc-${OCP_RELEASE_OLD}
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      oc apply -f ${REMOVABLE_MEDIA_PATH}/${MIRROR_OCP_REPOSITORY}-${release}/config/icsp.yaml
   done

   ```
     
3.11. Upload the catalog images to the local container registry:
   ```
   catalog_upload() {
      cd ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}
      oc adm catalog mirror file://${MIRROR_OLM_REPOSITORY}-${release}/${RH_REPOSITORY}/${RH_INDEX}:${release} ${LOCAL_REGISTRY}/${MIRROR_OLM_REPOSITORY}-${release} --insecure
   }

   alias oc=oc-${OCP_RELEASE_NEW}
   export release=${RH_INDEX_VERSION_NEW}
   catalog_upload

   alias oc=oc-${OCP_RELEASE_OLD}
   export release=${RH_INDEX_VERSION_OLD}
   catalog_upload

   ```

3.11. Create the CatalogSource object by running the following command to specify the catalogSource.yaml file in your manifests directory:
   ```
   alias oc=oc-${OCP_RELEASE_OLD}

   for release in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
      sed -i 's|name: .*$|name: '${MIRROR_OLM_REPOSITORY}-${release//./-}'|' ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}/manifests-${RH_INDEX}-*/catalogSource.yaml
      oc apply -f ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}/manifests-${RH_INDEX}-*/catalogSource.yaml
   done

   ```

3.12. Create the ImageContentSourcePolicy (ICSP) object by running the following command to specify the imageContentSourcePolicy.yaml file in your manifests directory:
   ```
   create_icsp() {
      cd ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}
      oc adm catalog mirror ${LOCAL_REGISTRY}/${MIRROR_OLM_REPOSITORY}-${release}/${RH_REPOSITORY}-${RH_INDEX}:${release} ${LOCAL_REGISTRY}/${MIRROR_OLM_REPOSITORY}-${release} --insecure --manifests-only
      sed -i 's|name: .*$|name: '${MIRROR_OLM_REPOSITORY}-${release//./-}'|' ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}/manifests-${RH_REPOSITORY}-${RH_INDEX}-*/imageContentSourcePolicy.yaml
      oc apply -f ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}/manifests-${RH_REPOSITORY}-${RH_INDEX}-*/imageContentSourcePolicy.yaml
   }

   export release=${RH_INDEX_VERSION_NEW}
   alias oc=oc-${OCP_RELEASE_NEW}
   create_icsp
  
   export release=${RH_INDEX_VERSION_OLD}
   alias oc=oc-${OCP_RELEASE_OLD}
   create_icsp

   ```

