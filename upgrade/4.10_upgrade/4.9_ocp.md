# DISCLAIMER
The following material is reproduced from the referenced guides and is provided exclusively for educational and training purposes.
It is provided on an "as-is" basis, without any express or implied warranties, and no responsibility is assumed for its accuracy, completeness, or applicability to any particular use.

---

# 1. Preparing your mirror host

NOTE:
> Run this whole procedure on a Linux machine with internet access and at least 1 TB of mounted storage.
> 
> YOU NEED TO BE THE ROOT USER (ID=0).

When you populate your mirror registry with OpenShift Container Platform images, 
if you do not have a host that can access both the internet and your mirror registry,
you must mirror the images to a file system and then bring that host or removable media into your restricted environment.
This process is referred to as disconnected mirroring.

#### Procedure
1.1. Set up your Red Hat account and link the Red Hat entitlement to your account. For help, see Accessing Red Hat entitlements from your IBM Cloud Pak:
   - https://www.ibm.com/docs/en/cloud-paks/1.0?topic=iocpc-accessing-red-hat-entitlements-from-your-cloud-paks
     
1.2. Obtain the pull secret file with Red Hat credentials from Red Hat OpenShift cluster manager and save as pull-secret.json:
   - https://console.redhat.com/openshift/install/pull-secret
     
1.3. Validate the external connectivity and Red Hat credentials by running:
   ```
   podman pull --authfile ${HOME}/pull-secret.json registry.redhat.io/openshift4/ose-local-storage-mustgather-rhel8
   ```

1.4. Set the required environment variables:
   ```
   export ARCH_RELEASE=x86_64
   #export LOCAL_SECRET_JSON=${XDG_RUNTIME_DIR}/containers/auth.json
   #export LOCAL_SECRET_JSON=${HOME}/.docker/config.json
   export LOCAL_SECRET_JSON=${HOME}/pull-secret.json
   export MIRROR_PORT=5000
   export MIRROR_PROTOCOL=http
   export MIRROR_HOST=mirror.hub.sebastian-colomar.com
   export OCP_RELEASE_NEW=4.9.59
   export OCP_RELEASE_OLD=4.8.37
   export OCP_REPOSITORY=ocp
   export PRODUCT_REPO=openshift-release-dev
   export RELEASE_NAME=ocp-release
   export REMOVABLE_MEDIA_PATH=/mnt/mirror
   ```
   ```
   export LOCAL_REGISTRY=${MIRROR_HOST}:${MIRROR_PORT}
   ```

1.5. Install the OpenShift CLI by downloading the binary:
   
   IMPORTANT:
   > If you are upgrading a cluster in a disconnected environment, install the oc version that you plan to upgrade to.

   ```
   export BINARIES="oc opm"
   export BINARY_PATH=${HOME}/bin
   export PACKAGES="openshift-client opm"
   ```
   ```
   cd ${HOME}
   mkdir -p ${BINARY_PATH}
   grep -q ":${BINARY_PATH}:" ~/.bashrc || echo "export PATH=\"${BINARY_PATH}:\${PATH}\"" | tee -a ~/.bashrc
   source ~/.bashrc
   ```
   ```
   unalias cp mv rm
   ```
   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      for package in ${PACKAGES}; do
        curl -O https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${release}/${package}-linux-${release}.tar.gz
        tar fxvz ${package}-linux-${release}.tar.gz
      done
      for binary in ${BINARIES}; do
        mv ${binary} ${BINARY_PATH}/${binary}-${release}
      done
   done
   ```
   ```
   rm -fv ${BINARY_PATH}/oc
   rm -fv ${BINARY_PATH}/opm
   ```

1.6. Mirror the images and configuration manifests to a directory on the removable media:

   ```
   touch ${HOME}/pull-secret.json
   ```
   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      sudo mkdir -p ${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}
      sudo chown -R ${USER}. ${REMOVABLE_MEDIA_PATH}
      oc-${release} adm release mirror -a ${LOCAL_SECRET_JSON} quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${release}-${ARCH_RELEASE} --to-dir=${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}
   done
   ```

1.7. Retrieve the ImageContentSourcePolicy:

   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      oc-${release} adm release mirror -a ${LOCAL_SECRET_JSON} quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${release}-${ARCH_RELEASE} --to=${LOCAL_REGISTRY}/${OCP_REPOSITORY}-${release} --to-release-image=${LOCAL_REGISTRY}/${OCP_REPOSITORY}-${release}:${release}-${ARCH_RELEASE} --insecure --dry-run | tee ${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}/config/icsp.yaml
      sed -i '0,/ImageContentSourcePolicy/d' ${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}/config/icsp.yaml
      sed -i /name:/s/example/${OCP_REPOSITORY}-${release}/ ${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}/config/icsp.yaml
   done
   ```

1.8. Create a tar archive containing the directory and its contents:

   ```
   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      cd ${REMOVABLE_MEDIA_PATH}
      tar cfv ${OCP_REPOSITORY}-${release}.tar ${OCP_REPOSITORY}-${release}
   done
   ```

1.9. Upload the generated tarball to the mirror host:
   ```
   export SSH_KEY=${HOME}/key.txt
   export REMOTE_USER=ec2-user
   export MIRROR_HOST=mirror.sebastian-colomar.com
   ```
   ```
   ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOTE_USER}@${MIRROR_HOST} "sudo mkdir -p ${REMOVABLE_MEDIA_PATH}"

   ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOTE_USER}@${MIRROR_HOST} "sudo chown ${REMOTE_USER}. ${REMOVABLE_MEDIA_PATH}"

   for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOVABLE_MEDIA_PATH}/${OCP_REPOSITORY}-${release}.tar ${REMOTE_USER}@${MIRROR_HOST}:${REMOVABLE_MEDIA_PATH}
   done

   ```

1.10. Upload the openshift client tarball to the mirror host:
   ```
    for release in ${OCP_RELEASE_NEW} ${OCP_RELEASE_OLD}; do
      for package in ${PACKAGES}; do
         scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${HOME}/${package}-linux-${release}.tar.gz ${REMOTE_USER}@${MIRROR_HOST}:
      done
    done
   ```

