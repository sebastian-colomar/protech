# DISCLAIMER
The following material is reproduced from the referenced guides and is provided exclusively for educational and training purposes.
It is provided on an "as-is" basis, without any express or implied warranties, and no responsibility is assumed for its accuracy, completeness, or applicability to any particular use.

---

# 2. Using Operator Lifecycle Manager on restricted networks 

## Red Hat references:
> - https://docs.redhat.com/en/documentation/openshift_container_platform/4.8/html/operators/administrator-tasks
> - https://docs.redhat.com/en/documentation/openshift_container_platform/4.9/html/operators/administrator-tasks

NOTE:
> Run this whole procedure on a Linux machine with internet access and at least 1 TB of mounted storage.
>
> YOU NEED TO BE THE ROOT USER (ID=0).


For OpenShift Container Platform clusters that are installed on restricted networks, also known as disconnected clusters, Operator Lifecycle Manager (OLM) by default cannot access the Red Hat-provided OperatorHub sources hosted on remote registries because those remote sources require full internet connectivity.

However, as a cluster administrator you can still enable your cluster to use OLM in a restricted network if you have a workstation that has full internet access. The workstation, which requires full internet access to pull the remote OperatorHub content, is used to prepare local mirrors of the remote sources, and push the content to a mirror registry.

The mirror registry can be located on a bastion host, which requires connectivity to both your workstation and the disconnected cluster, or a completely disconnected, or airgapped, host, which requires removable media to physically move the mirrored content to the disconnected environment.

## Pruning an index image

An index image, based on the Operator bundle format, is a containerized snapshot of an Operator catalog. You can prune an index of all but a specified list of packages, which creates a copy of the source index containing only the Operators that you want.

### Procedure

2.1. Set up environment variables:
   ```
   export ARCH_CATALOG=amd64
   export ARCH_RELEASE=x86_64
   export CONTAINER_IMAGE=docker.io/library/registry
   export CONTAINER_IMAGE_TAG=2.7
   export CONTAINER_NAME=registry
   export CONTAINER_PORT=5000
   export CONTAINER_VOLUME=/var/lib/registry
   #export LOCAL_SECRET_JSON=${XDG_RUNTIME_DIR}/containers/auth.json
   #export LOCAL_SECRET_JSON=${HOME}/.docker/config.json
   export LOCAL_SECRET_JSON=${HOME}/pull-secret.json
   export MIRROR_HOST=mirror.hub.sebastian-colomar.com
   export MIRROR_PORT=5000
   export MIRROR_PROTOCOL=http
   export OCP_RELEASE_NEW=4.9.59
   export OCP_RELEASE_OLD=4.8.37
   export OCP_REPOSITORY=ocp
   export PKGS='cluster-logging,elasticsearch-operator,ibm-spectrum-symphony-operator,local-storage-operator,ocs-operator,odf-operator'
   export PRODUCT_REPO=openshift-release-dev
   export RELEASE_NAME=ocp-release
   export REMOTE_USER=ec2-user
   export REMOVABLE_MEDIA_PATH=/mnt/mirror
   export RH_INDEX_LIST='certified-operator-index redhat-operator-index'
   export RH_INDEX_VERSION_NEW=v4.9
   export RH_INDEX_VERSION_OLD=v4.8
   export RH_REGISTRY=registry.redhat.io
   export RH_REPOSITORY=redhat
   export SSH_KEY=${HOME}/key.txt

   export CONTAINERS_STORAGE_CONF=${REMOVABLE_MEDIA_PATH}/containers/storage.conf
   export LOCAL_REGISTRY=${MIRROR_HOST}:${MIRROR_PORT}
   export MIRROR_OCP_REPOSITORY=mirror-${OCP_REPOSITORY}
   export TMPDIR=${REMOVABLE_MEDIA_PATH}/containers/cache

   ```

2.1. Allow unsigned registries for the Certified Operator Index:

   ```
   sudo sed -i '/"registry.redhat.io": \[/i\
               "registry.redhat.io/redhat/certified-operator-index": [\
                   {\
                       "type": "insecureAcceptAnything"\
                   }\
               ],' /etc/containers/policy.json

   ```

2.2. Run the source index image that you want to prune in a container:
   ```
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/cache
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/containers
   mkdir -p ${REMOVABLE_MEDIA_PATH}/containers/containers-run

   tee ${REMOVABLE_MEDIA_PATH}/containers/storage.conf 0<<EOF
   [storage]
   driver = "overlay"
   graphroot = "${REMOVABLE_MEDIA_PATH}/containers/containers"
   runroot = "${REMOVABLE_MEDIA_PATH}/containers/containers-run"
   EOF

   semanage fcontext -a -t container_file_t "${REMOVABLE_MEDIA_PATH}/containers/containers(/.*)?"
   semanage fcontext -a -t container_var_run_t "${REMOVABLE_MEDIA_PATH}/containers/containers-run(/.*)?"
   restorecon -Rv ${REMOVABLE_MEDIA_PATH}/containers/containers ${REMOVABLE_MEDIA_PATH}/containers/containers-run

   podman info | egrep 'graphRoot:|runRoot:|imageCopyTmpDir:'

   for RH_INDEX in ${RH_INDEX_LIST}; do
      for version in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
         podman run --authfile ${LOCAL_SECRET_JSON} -d --name ${RH_INDEX}-${version} -p 50051 --rm ${RH_REGISTRY}/${RH_REPOSITORY}/${RH_INDEX}:${version}
      done
   done

   ```

2.3. Use the grpcurl command to get a list of the packages provided by the index:
   ```
   for RH_INDEX in ${RH_INDEX_LIST}; do
      for version in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
         node_port=$( podman port ${RH_INDEX}-${version} | cut -d: -f2 )
         podman run --rm --network host docker.io/fullstorydev/grpcurl:latest -plaintext localhost:${node_port} api.Registry/ListPackages | grep '"name"' | cut -d '"' -f4 | sort -u | tee ${REMOVABLE_MEDIA_PATH}/${RH_INDEX}-${version}.txt
      done
   done

   ```
   
2.4. Inspect the `${RH_INDEX}-${version}.txt` file and identify which package names from this list you want to keep in your pruned index.

   Alternatively, list your current subscriptions:
   ```
   alias oc=oc-${OCP_RELEASE_OLD}
   export PKGS=$(oc get subscriptions -A -o jsonpath='{range .items[*]}{.spec.name}{"\n"}{end}' | sort -u | paste -sd, -)

   ```

2.7. Deploy the local container registry using the Distribution container image with the HTTP protocol:
   ```
   mkdir -p ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}

   podman run -d --name ${CONTAINER_NAME} --restart=always -p ${MIRROR_PORT}:${CONTAINER_PORT} -v ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}:${CONTAINER_VOLUME}:Z ${CONTAINER_IMAGE}:${CONTAINER_IMAGE_TAG}

   podman save > ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}.tar ${CONTAINER_IMAGE}:${CONTAINER_IMAGE_TAG}

   tee /etc/containers/registries.conf.d/99-localhost-insecure.conf >/dev/null <<EOF
   [[registry]]
   location = "localhost:${MIRROR_PORT}"
   insecure = true
   EOF

   ```

2.6. Run the following command to prune the source index of all but the specified packages and push the new index image to your target registry:
   ```
   podman info | egrep 'graphRoot:|runRoot:|imageCopyTmpDir:'

   mkdir -p ${HOME}/.docker
   cp -fv ${LOCAL_SECRET_JSON} ${HOME}/.docker/config.json

   alias opm-${RH_INDEX_VERSION_NEW}=opm-${OCP_RELEASE_NEW}
   alias opm-${RH_INDEX_VERSION_OLD}=opm-${OCP_RELEASE_OLD}

   for RH_INDEX in ${RH_INDEX_LIST}; do

      for version in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do

         export INDEX_IMAGE=${RH_REGISTRY}/${RH_REPOSITORY}/${RH_INDEX}:${version}   
         export INDEX_IMAGE_PRUNED=localhost:${MIRROR_PORT}/${RH_REPOSITORY}/${RH_INDEX}:${version}

         opm-${version} index prune -f ${INDEX_IMAGE} -p "${PKGS}" -t ${INDEX_IMAGE_PRUNED}  
         podman push ${INDEX_IMAGE_PRUNED} --remove-signatures

         podman run -d --name ${RH_INDEX}-${version}-pruned -p 50051 --rm ${INDEX_IMAGE_PRUNED}
         export node_port=$( podman port ${RH_INDEX}-${version}-pruned | cut -d: -f2 )
         podman run --rm --network host docker.io/fullstorydev/grpcurl:latest -plaintext localhost:${node_port} api.Registry/ListPackages | grep '"name"' | cut -d '"' -f4 | sort -u | tee ${REMOVABLE_MEDIA_PATH}/${RH_INDEX}-${version}-pruned.txt

      done

   done

   ```

2.4. Inspect the `${RH_INDEX}-${version}-pruned.txt` file and identify which package names from this list you want to keep in your pruned index.

2.9. Run the following command on your workstation with unrestricted network access to mirror the content to local files:
   ```
   catalog_download() {
      cd ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}
      ${oc} adm catalog mirror ${pruned} file://${MIRROR_OLM_REPOSITORY}-${release} -a ${LOCAL_SECRET_JSON} --index-filter-by-os=linux/${ARCH_CATALOG} --insecure
      ${oc} version
   }

   for RH_INDEX in ${RH_INDEX_LIST}; do

      export INDEX_IMAGE_PRUNED_NEW=localhost:${MIRROR_PORT}/${RH_REPOSITORY}/${RH_INDEX}:${RH_INDEX_VERSION_NEW}
      export INDEX_IMAGE_PRUNED_OLD=localhost:${MIRROR_PORT}/${RH_REPOSITORY}/${RH_INDEX}:${RH_INDEX_VERSION_OLD}
      export MIRROR_OLM_REPOSITORY=mirror-${RH_INDEX}

      for release in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
         mkdir -p ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}
      done
   
      export oc=oc-${OCP_RELEASE_NEW}
      export pruned=${INDEX_IMAGE_PRUNED_NEW}
      export release=${RH_INDEX_VERSION_NEW}
      catalog_download
   
      export oc=oc-${OCP_RELEASE_OLD}
      export pruned=${INDEX_IMAGE_PRUNED_OLD}
      export release=${RH_INDEX_VERSION_OLD}
      catalog_download

   done

   ```

2.10. Copy the directory that is generated in your current directory to removable media:
   ```
   cd ${REMOVABLE_MEDIA_PATH}
   for RH_INDEX in ${RH_INDEX_LIST}; do
      export MIRROR_OLM_REPOSITORY=mirror-${RH_INDEX}
      for release in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
         tar cfv ${MIRROR_OLM_REPOSITORY}-${release}.tar ${MIRROR_OLM_REPOSITORY}-${release}
      done
   done

   ```

2.11. Upload the generated tarball to the mirror host:
   ```
   export MIRROR_HOST=mirror.sebastian-colomar.com

   mirror_remote_exec() {
      ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOTE_USER}@${MIRROR_HOST} "$@"
   }

   ```
   ```
   mirror_remote_exec "sudo mkdir -p ${REMOVABLE_MEDIA_PATH}"

   ```
   ```
   mirror_remote_exec "sudo chown ${REMOTE_USER}. ${REMOVABLE_MEDIA_PATH}"

   ```
   ```
   for RH_INDEX in ${RH_INDEX_LIST}; do
      export MIRROR_OLM_REPOSITORY=mirror-${RH_INDEX}
      for release in ${RH_INDEX_VERSION_NEW} ${RH_INDEX_VERSION_OLD}; do
         scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOVABLE_MEDIA_PATH}/${MIRROR_OLM_REPOSITORY}-${release}.tar ${REMOTE_USER}@${MIRROR_HOST}:${REMOVABLE_MEDIA_PATH}
      done
   done

   scp -i ${SSH_KEY} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${REMOVABLE_MEDIA_PATH}/${CONTAINER_NAME}.tar ${REMOTE_USER}@${MIRROR_HOST}:${REMOVABLE_MEDIA_PATH}

   mirror_remote_exec "sudo chown -R ${USER}. ${REMOVABLE_MEDIA_PATH}"

   ```

## (ONLY IF NECESSARY9 Disabling the default OperatorHub sources 

Operator catalogs that source content provided by Red Hat and community projects are configured for OperatorHub by default during an OpenShift Container Platform installation. In a restricted network environment, you must disable the default catalogs as a cluster administrator. You can then configure OperatorHub to use local catalog sources.

### Procedure

- (ONLY IF NECESSARY) Disable the sources for the default catalogs by adding `disableAllDefaultSources: true` to the OperatorHub object:
   ```
   alias oc=oc-${OCP_RELEASE_OLD}
   oc patch OperatorHub cluster --type json -p '[{"op": "add", "path": "/spec/disableAllDefaultSources", "value": true}]'
   
   ```


