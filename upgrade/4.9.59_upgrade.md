# DISCLAIMER
The following material is reproduced from the referenced guides and is provided exclusively for educational and training purposes.
It is provided on an "as-is" basis, without any express or implied warranties, and no responsibility is assumed for its accuracy, completeness, or applicability to any particular use.

---

### Important:
> You must upgrade to Cyclops 4.0 before upgrading Red Hat OpenShift Container Platform (OCP) and OpenShift Data Foundation (ODF) to version 4.10. For installation instructions, see the README file:
> - https://download4.boulder.ibm.com/sar/CMA/WSA/0bnji/0/readme.txt

--- 

# Upgrade from version 4.8.37 to 4.9.59

Red Hat references:
- https://docs.redhat.com/en/documentation/openshift_container_platform/4.8/html/installing/installing-mirroring-installation-images
- https://docs.redhat.com/en/documentation/openshift_container_platform/4.8/html/updating_clusters/updating-a-cluster-in-a-disconnected-environment

---

## Updating a cluster in a disconnected environment
- https://docs.redhat.com/en/documentation/openshift_container_platform/4.8/html/updating_clusters/updating-a-cluster-in-a-disconnected-environment

### Mirroring the OpenShift Container Platform image repository

---

# 1. Preparing your mirror host

NOTE:
> Run this whole procedure on a Linux machine with internet access and at least 1 TB of mounted storage.

When you populate your mirror registry with OpenShift Container Platform images, 
if you do not have a host that can access both the internet and your mirror registry,
you must mirror the images to a file system and then bring that host or removable media into your restricted environment.
This process is referred to as disconnected mirroring.

##### Procedure
1. Set up your Red Hat account and link the Red Hat entitlement to your account. For help, see Accessing Red Hat entitlements from your IBM Cloud Pak:
   - https://www.ibm.com/docs/en/cloud-paks/1.0?topic=iocpc-accessing-red-hat-entitlements-from-your-cloud-paks
2. Obtain the pull secret file with Red Hat credentials from Red Hat OpenShift cluster manager and save as pull-secret.json:
   - https://console.redhat.com/openshift/install/pull-secret
3. Validate the external connectivity and Red Hat credentials by running:
   ```
   podman pull --authfile ${HOME}/pull-secret.json registry.redhat.io/openshift4/ose-local-storage-mustgather-rhel8
   ```
3. Set the required environment variables:
   
   a. Export the release version:
   
      ```
      export OCP_RELEASE=4.9.59
      ```
      Specify the tag that corresponds to the version of OpenShift Container Platform to which you want to update.
   
   b. Export the local registry name and host port:
   
      ```
      export MIRROR_PORT=5000
      export MIRROR_HOST=mirror.hub.sebastian-colomar.com
      ```
      ```
      export LOCAL_REGISTRY=${MIRROR_HOST}:${MIRROR_PORT}
      ```
      Specify the registry domain name for your mirror repository, and the port that it serves content on.

   c. Export the local repository name:

      ```
      export LOCAL_REPOSITORY=ocp
      ```
      Specify the name of the repository to create in your registry.

   d. Export the name of the repository to mirror:

      ```
      export PRODUCT_REPO=openshift-release-dev
      ```

   e. Export the path to your registry pull secret:

      ```
      export LOCAL_SECRET_JSON=${XDG_RUNTIME_DIR}/containers/auth.json
      #export LOCAL_SECRET_JSON=${HOME}/.docker/config.json
      ```

   f. Export the release mirror:

      ```
      export RELEASE_NAME=ocp-release
      ```

   g. Export the type of architecture for your server, such as x86_64:

      ```
      export ARCHITECTURE=x86_64
      ```

   h. Export the path to the directory to host the mirrored images:

      ```
      export REMOVABLE_MEDIA_PATH=/mnt/mirror
      ```
4. Install the OpenShift CLI by downloading the binary:
   
   IMPORTANT:
   > If you are upgrading a cluster in a disconnected environment, install the oc version that you plan to upgrade to.

    ```
    export BINARY_PATH=${HOME}/bin
    export PACKAGE_NAME=openshift-client-linux.tar.gz
    ```
    ```
    mkdir -p ${BINARY_PATH}
    grep -q ":${BINARY_PATH}:" ~/.bashrc || echo "export PATH=\"${BINARY_PATH}:\${PATH}\"" | tee -a ~/.bashrc
    source ~/.bashrc
    curl -O https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${OCP_RELEASE}/${PACKAGE_NAME}
    tar fxvz ${PACKAGE_NAME}
    binaries='kubectl oc'
    for binary in ${binaries}
      do
        mv ${binary} ${BINARY_PATH}
      done    
    oc version
    ```

4. Mirror the images and configuration manifests to a directory on the removable media:

   ```
   sudo mkdir -p ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}
   sudo chown -R ${USER}. ${REMOVABLE_MEDIA_PATH}
   ```
   ```
   oc adm release mirror -a ${LOCAL_SECRET_JSON} quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE} --to-dir=${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}
   ```

3. Retrieve the ImageContentSourcePolicy:

   ```
   oc adm release mirror -a ${LOCAL_SECRET_JSON} quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE} --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE} --insecure --dry-run | tee ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}/config/icsp.yaml
   sed -i '0,/ImageContentSourcePolicy/d' ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}/config/icsp.yaml
   ```

5. Create a tar archive containing the directory and its contents:

   ```
   cd ${REMOVABLE_MEDIA_PATH}
   sudo tar cfv ${LOCAL_REPOSITORY}.tar ${LOCAL_REPOSITORY}
   #sudo gzip -v ${LOCAL_REPOSITORY}.tar
   ```

5. Upload the generated tarball to the mirror host:
   ```
   export SSH_KEY=${HOME}/key.txt
   export REMOTE_USER=ec2-user
   export MIRROR_HOST=mirror.sebastian-colomar.com
   ```
   ```
   ssh -i ${SSH_KEY} ${REMOTE_USER}@${MIRROR_HOST} "sudo mkdir -p ${REMOVABLE_MEDIA_PATH}"
   ssh -i ${SSH_KEY} ${REMOTE_USER}@${MIRROR_HOST} "sudo chown ${REMOTE_USER}. ${REMOVABLE_MEDIA_PATH}"
   scp -i ${SSH_KEY} ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}.tar ${REMOTE_USER}@${MIRROR_HOST}:${REMOVABLE_MEDIA_PATH}
   ```
   
5. Upload the openshift client tarball to the mirror host:
   ```
   scp -i ${SSH_KEY} ${HOME}/${PACKAGE_NAME} ${REMOTE_USER}@${MIRROR_HOST}:
   ```

---

# 2. Mirror registry for Red Hat OpenShift

NOTE:
> Execute this procedure on a Linux machine reachable by the OpenShift cluster and equipped with at least 1 TB of mounted storage.

##### Procedure
1. Set the required environment variables:
   
   a. Export the release version:
   
      ```
      export OCP_RELEASE=4.9.59
      ```
      Specify the tag that corresponds to the version of OpenShift Container Platform to which you want to update.
   
   b. Export the local registry name and host port:
   
      ```
      export MIRROR_PORT=5000
      export MIRROR_HOST=mirror.hub.sebastian-colomar.com
      ```
      ```
      export LOCAL_REGISTRY=${MIRROR_HOST}:${MIRROR_PORT}
      ```
      Specify the registry domain name for your mirror repository, and the port that it serves content on.

   c. Export the local repository name:

      ```
      export LOCAL_REPOSITORY=ocp
      ```
      Specify the name of the repository to create in your registry.

   d. Export the name of the repository to mirror:

      ```
      export PRODUCT_REPO=openshift-release-dev
      ```

   e. Export the path to your registry pull secret:

      ```
      export LOCAL_SECRET_JSON=${XDG_RUNTIME_DIR}/containers/auth.json
      #export LOCAL_SECRET_JSON=${HOME}/.docker/config.json
      ```

   f. Export the release mirror:

      ```
      export RELEASE_NAME=ocp-release
      ```

   g. Export the type of architecture for your server, such as x86_64:

      ```
      export ARCHITECTURE=x86_64
      ```

   h. Export the path to the directory to host the mirrored images:

      ```
      export REMOVABLE_MEDIA_PATH=/mnt/mirror
      ```
  
5. Extract the tar archive containing the directory of the mirrored images and its contents:

   ```
   cd ${REMOVABLE_MEDIA_PATH}
   #gunzip -v ${LOCAL_REPOSITORY}.tar.gz
   tar fvxz ${LOCAL_REPOSITORY}.tar
   ```

1. Deploy the local container registry using the Distribution container image with the HTTP protocol:
    ```
    export CONTAINER_IMAGE=docker.io/library/registry
    export CONTAINER_IMAGE_TAG=2.7
    export CONTAINER_NAME=registry
    export CONTAINER_PORT=5000
    export CONTAINER_VOLUME=/var/lib/registry
    export MIRROR_PORT=5000
    ```
    ```
    sudo mkdir -p ${CONTAINER_VOLUME}
    sudo podman run -d --name ${CONTAINER_NAME} --restart=always -p ${MIRROR_PORT}:${CONTAINER_PORT} -v ${CONTAINER_VOLUME}:${CONTAINER_VOLUME}:Z ${CONTAINER_IMAGE}:${CONTAINER_IMAGE_TAG}
    ```

4. Install the OpenShift CLI:
   
   IMPORTANT:
   > If you are upgrading a cluster in a disconnected environment, install the oc version that you plan to upgrade to.

    ```
    export BINARY_PATH=${HOME}/bin
    export PACKAGE_NAME=openshift-client-linux.tar.gz
    ```
    ```
    mkdir -p ${BINARY_PATH}
    grep -q ":${BINARY_PATH}:" ~/.bashrc || echo "export PATH=\"${BINARY_PATH}:\${PATH}\"" | tee -a ~/.bashrc
    source ~/.bashrc
    tar fvxz ${PACKAGE_NAME}
    binaries='kubectl oc'
    for binary in ${binaries}
      do
        mv ${binary} ${BINARY_PATH}
      done    
    oc version
    ```

4. Upload the images to the local container registry:

   ```
   sudo mkdir -p ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}
   sudo chown -R ${USER}. ${REMOVABLE_MEDIA_PATH}
   ```
   ```
   oc image mirror "file://openshift/release:${OCP_RELEASE}*" ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} --from-dir=${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY} --insecure
   ```

--- 

1. Print the mirrored release image signature ConfigMap to standard output:

   ```
   cat ${REMOVABLE_MEDIA_PATH}/${LOCAL_REPOSITORY}/config/signature-sha256-*.yaml
   ```

8. Copy the output content and paste it as a new resource in the OpenShift cluster using the following URL:
   - https://console-openshift-console.apps.hub.sebastian-colomar.com/k8s/ns/openshift-config-managed/import
